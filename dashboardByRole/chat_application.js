/*
 * Copyright (c) 2010 Nick Galbreath
 * http://code.google.com/p/stringencoders/source/browse/#svn/trunk/javascript
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 */
/**
 * Timeago is a jQuery plugin that makes it easy to support automatically
 * updating fuzzy timestamps (e.g. "4 minutes ago" or "about 1 day ago").
 *
 * @name timeago
 * @version 0.10.0
 * @requires jQuery v1.2.3+
 * @author Ryan McGeary
 * @license MIT License - http://www.opensource.org/licenses/mit-license.php
 *
 * For usage and examples, visit:
 * http://timeago.yarp.com/
 *
 * Copyright (c) 2008-2011, Ryan McGeary (ryanonjavascript -[at]- mcgeary [*dot*] org)
 */
function includeTimeago(){!function(e){function t(){var t=n(this);return isNaN(t.datetime)||e(this).text(i(t.datetime)),this}function n(t){if(t=e(t),!t.data("timeago")){t.data("timeago",{datetime:s.datetime(t)});var n=e.trim(t.text());n.length>0&&t.attr("title",n)}return t.data("timeago")}function i(e){return s.inWords(r(e))}function r(e){return(new Date).getTime()-e.getTime()}e.timeago=function(t){return t instanceof Date?i(t):"string"==typeof t?i(e.timeago.parse(t)):i(e.timeago.datetime(t))};var s=e.timeago;e.extend(e.timeago,{settings:{refreshMillis:6e4,allowFuture:!1,strings:{prefixAgo:null,prefixFromNow:null,suffixAgo:"ago",suffixFromNow:"from now",seconds:"less than a minute",minute:"about a minute",minutes:"%d minutes",hour:"about an hour",hours:"about %d hours",day:"a day",days:"%d days",month:"about a month",months:"%d months",year:"about a year",years:"%d years",numbers:[]}},inWords:function(t){function n(n,r){var s=e.isFunction(n)?n(r,t):n,o=i.numbers&&i.numbers[r]||r;return s.replace(/%d/i,o)}var i=this.settings.strings,r=i.prefixAgo,s=i.suffixAgo;this.settings.allowFuture&&0>t&&(r=i.prefixFromNow,s=i.suffixFromNow);var o=Math.abs(t)/1e3,a=o/60,l=a/60,u=l/24,c=u/365,h=45>o&&n(i.seconds,Math.round(o))||90>o&&n(i.minute,1)||45>a&&n(i.minutes,Math.round(a))||90>a&&n(i.hour,1)||24>l&&n(i.hours,Math.round(l))||48>l&&n(i.day,1)||30>u&&n(i.days,Math.floor(u))||60>u&&n(i.month,1)||365>u&&n(i.months,Math.floor(u/30))||2>c&&n(i.year,1)||n(i.years,Math.floor(c));return e.trim([r,h,s].join(" "))},parse:function(t){var n=e.trim(t);return n=n.replace(/\.\d\d\d+/,""),n=n.replace(/-/,"/").replace(/-/,"/"),n=n.replace(/T/," ").replace(/Z/," UTC"),n=n.replace(/([\+\-]\d\d)\:?(\d\d)/," $1$2"),new Date(n)},datetime:function(t){var n="time"===e(t).get(0).tagName.toLowerCase(),i=n?e(t).attr("datetime"):e(t).attr("title");return s.parse(i)}}),e.fn.timeago=function(){var e=this;e.each(t);var n=s.settings;return n.refreshMillis>0&&setInterval(function(){e.each(t)},n.refreshMillis),e},document.createElement("abbr"),document.createElement("time")}(jQuery)}var base64={};base64.PADCHAR="=",base64.ALPHA="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",base64.makeDOMException=function(){try{return new DOMException(DOMException.INVALID_CHARACTER_ERR)}catch(e){var t=new Error("DOM Exception 5");return t.code=t.number=5,t.name=t.description="INVALID_CHARACTER_ERR",t.toString=function(){return"Error: "+t.name+": "+t.message},t}},base64.getbyte64=function(e,t){var n=base64.ALPHA.indexOf(e.charAt(t));if(-1===n)throw base64.makeDOMException();return n},base64.decode=function(e){e=""+e;var t,n,i,r=base64.getbyte64,s=e.length;if(0===s)return e;if(0!==s%4)throw base64.makeDOMException();t=0,e.charAt(s-1)===base64.PADCHAR&&(t=1,e.charAt(s-2)===base64.PADCHAR&&(t=2),s-=4);var o=[];for(n=0;s>n;n+=4)i=r(e,n)<<18|r(e,n+1)<<12|r(e,n+2)<<6|r(e,n+3),o.push(String.fromCharCode(i>>16,255&i>>8,255&i));switch(t){case 1:i=r(e,n)<<18|r(e,n+1)<<12|r(e,n+2)<<6,o.push(String.fromCharCode(i>>16,255&i>>8));break;case 2:i=r(e,n)<<18|r(e,n+1)<<12,o.push(String.fromCharCode(i>>16))}return o.join("")},base64.getbyte=function(e,t){var n=e.charCodeAt(t);if(n>255)throw base64.makeDOMException();return n},base64.encode=function(e){if(1!==arguments.length)throw new SyntaxError("Not enough arguments");var t,n,i=base64.PADCHAR,r=base64.ALPHA,s=base64.getbyte,o=[];e=""+e;var a=e.length-e.length%3;if(0===e.length)return e;for(t=0;a>t;t+=3)n=s(e,t)<<16|s(e,t+1)<<8|s(e,t+2),o.push(r.charAt(n>>18)),o.push(r.charAt(63&n>>12)),o.push(r.charAt(63&n>>6)),o.push(r.charAt(63&n));switch(e.length-a){case 1:n=s(e,t)<<16,o.push(r.charAt(n>>18)+r.charAt(63&n>>12)+i+i);break;case 2:n=s(e,t)<<16|s(e,t+1)<<8,o.push(r.charAt(n>>18)+r.charAt(63&n>>12)+r.charAt(63&n>>6)+i)}return o.join("")},window.btoa||(window.btoa=base64.encode),window.atob||(window.atob=base64.decode);var Faye="object"==typeof Faye?Faye:{};"undefined"!=typeof window&&(window.Faye=Faye),Faye.extend=function(e,t,n){if(!t)return e;for(var i in t)t.hasOwnProperty(i)&&(e.hasOwnProperty(i)&&n===!1||e[i]!==t[i]&&(e[i]=t[i]));return e},Faye.extend(Faye,{VERSION:"0.8.8",BAYEUX_VERSION:"1.0",ID_LENGTH:160,JSONP_CALLBACK:"jsonpcallback",CONNECTION_TYPES:["long-polling","cross-origin-long-polling","callback-polling","websocket","eventsource","in-process"],MANDATORY_CONNECTION_TYPES:["long-polling","callback-polling","in-process"],ENV:function(){return this}(),random:function(e){if(e=e||this.ID_LENGTH,e>32){for(var t=Math.ceil(e/32),n="";t--;)n+=this.random(32);for(var i=n.split(""),r="";i.length>0;)r+=i.pop();return r}for(var s=Math.pow(2,e)-1,o=s.toString(36).length,n=Math.floor(Math.random()*s).toString(36);n.length<o;)n="0"+n;return n},clientIdFromMessages:function(e){var t=[].concat(e)[0];return t&&t.clientId},copyObject:function(e){var t,n,i;if(e instanceof Array){for(t=[],n=e.length;n--;)t[n]=Faye.copyObject(e[n]);return t}if("object"==typeof e){t=null===e?null:{};for(i in e)t[i]=Faye.copyObject(e[i]);return t}return e},commonElement:function(e,t){for(var n=0,i=e.length;i>n;n++)if(-1!==this.indexOf(t,e[n]))return e[n];return null},indexOf:function(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0,i=e.length;i>n;n++)if(e[n]===t)return n;return-1},map:function(e,t,n){if(e.map)return e.map(t,n);var i=[];if(e instanceof Array)for(var r=0,s=e.length;s>r;r++)i.push(t.call(n||null,e[r],r));else for(var o in e)e.hasOwnProperty(o)&&i.push(t.call(n||null,o,e[o]));return i},filter:function(e,t,n){for(var i=[],r=0,s=e.length;s>r;r++)t.call(n||null,e[r],r)&&i.push(e[r]);return i},asyncEach:function(e,t,n,i){var r=e.length,s=-1,o=0,a=!1,l=function(){return o-=1,s+=1,s===r?n&&n.call(i):(t(e[s],c),void 0)},u=function(){if(!a){for(a=!0;o>0;)l();a=!1}},c=function(){o+=1,u()};c()},toJSON:function(e){return this.stringify?this.stringify(e,function(e,t){return this[e]instanceof Array?this[e]:t}):JSON.stringify(e)},logger:function(e){"undefined"!=typeof console&&console.log(e)},timestamp:function(){var e=new Date,t=e.getFullYear(),n=e.getMonth()+1,i=e.getDate(),r=e.getHours(),s=e.getMinutes(),o=e.getSeconds(),a=function(e){return 10>e?"0"+e:String(e)};return a(t)+"-"+a(n)+"-"+a(i)+" "+a(r)+":"+a(s)+":"+a(o)}}),Faye.Class=function(e,t){"function"!=typeof e&&(t=e,e=Object);var n=function(){return this.initialize?this.initialize.apply(this,arguments)||this:this},i=function(){};return i.prototype=e.prototype,n.prototype=new i,Faye.extend(n.prototype,t),n},Faye.Namespace=Faye.Class({initialize:function(){this._e={}},exists:function(e){return this._e.hasOwnProperty(e)},generate:function(){for(var e=Faye.random();this._e.hasOwnProperty(e);)e=Faye.random();return this._e[e]=e},release:function(e){delete this._e[e]}}),Faye.Error=Faye.Class({initialize:function(e,t,n){this.code=e,this.params=Array.prototype.slice.call(t),this.message=n},toString:function(){return this.code+":"+this.params.join(",")+":"+this.message}}),Faye.Error.parse=function(e){if(e=e||"",!Faye.Grammar.ERROR.test(e))return new this(null,[],e);var t=e.split(":"),n=parseInt(t[0]),i=t[1].split(","),e=t[2];return new this(n,i,e)},Faye.Error.versionMismatch=function(){return new this(300,arguments,"Version mismatch").toString()},Faye.Error.conntypeMismatch=function(){return new this(301,arguments,"Connection types not supported").toString()},Faye.Error.extMismatch=function(){return new this(302,arguments,"Extension mismatch").toString()},Faye.Error.badRequest=function(){return new this(400,arguments,"Bad request").toString()},Faye.Error.clientUnknown=function(){return new this(401,arguments,"Unknown client").toString()},Faye.Error.parameterMissing=function(){return new this(402,arguments,"Missing required parameter").toString()},Faye.Error.channelForbidden=function(){return new this(403,arguments,"Forbidden channel").toString()},Faye.Error.channelUnknown=function(){return new this(404,arguments,"Unknown channel").toString()},Faye.Error.channelInvalid=function(){return new this(405,arguments,"Invalid channel").toString()},Faye.Error.extUnknown=function(){return new this(406,arguments,"Unknown extension").toString()},Faye.Error.publishFailed=function(){return new this(407,arguments,"Failed to publish").toString()},Faye.Error.serverError=function(){return new this(500,arguments,"Internal server error").toString()},Faye.Deferrable={callback:function(e,t){if(e){if("succeeded"===this._w)return e.apply(t,this._j);this._k=this._k||[],this._k.push([e,t])}},timeout:function(e,t){var n=this,i=Faye.ENV.setTimeout(function(){n.setDeferredStatus("failed",t)},1e3*e);this._x=i},errback:function(e,t){if(e){if("failed"===this._w)return e.apply(t,this._j);this._l=this._l||[],this._l.push([e,t])}},setDeferredStatus:function(){this._x&&Faye.ENV.clearTimeout(this._x);var e,t=Array.prototype.slice.call(arguments),n=t.shift();if(this._w=n,this._j=t,"succeeded"===n?e=this._k:"failed"===n&&(e=this._l),e)for(var i;i=e.shift();)i[0].apply(i[1],this._j)}},Faye.Publisher={countListeners:function(e){return this._3&&this._3[e]?this._3[e].length:0},bind:function(e,t,n){this._3=this._3||{};var i=this._3[e]=this._3[e]||[];i.push([t,n])},unbind:function(e,t,n){if(this._3&&this._3[e]){if(!t)return delete this._3[e],void 0;for(var i=this._3[e],r=i.length;r--;)t===i[r][0]&&(n&&i[r][1]!==n||i.splice(r,1))}},trigger:function(){var e=Array.prototype.slice.call(arguments),t=e.shift();if(this._3&&this._3[t])for(var n,i=this._3[t].slice(),r=0,s=i.length;s>r;r++)n=i[r],n[0].apply(n[1],e)}},Faye.Timeouts={addTimeout:function(e,t,n,i){if(this._5=this._5||{},!this._5.hasOwnProperty(e)){var r=this;this._5[e]=Faye.ENV.setTimeout(function(){delete r._5[e],n.call(i)},1e3*t)}},removeTimeout:function(e){this._5=this._5||{};var t=this._5[e];t&&(clearTimeout(t),delete this._5[e])}},Faye.Logging={LOG_LEVELS:{error:3,warn:2,info:1,debug:0},logLevel:"error",log:function(e,t){if(Faye.logger){var n=Faye.Logging.LOG_LEVELS;if(!(n[Faye.Logging.logLevel]>n[t])){var e=Array.prototype.slice.apply(e),i=" ["+t.toUpperCase()+"] [Faye",r=this.className,s=e.shift().replace(/\?/g,function(){try{return Faye.toJSON(e.shift())}catch(t){return"[Object]"}});for(var o in Faye)r||"function"==typeof Faye[o]&&this instanceof Faye[o]&&(r=o);r&&(i+="."+r),i+="] ",Faye.logger(Faye.timestamp()+i+s)}}}},function(){for(var e in Faye.Logging.LOG_LEVELS)!function(e){Faye.Logging[e]=function(){this.log(arguments,e)}}(e,Faye.Logging.LOG_LEVELS[e])}(),Faye.Grammar={LOWALPHA:/^[a-z]$/,UPALPHA:/^[A-Z]$/,ALPHA:/^([a-z]|[A-Z])$/,DIGIT:/^[0-9]$/,ALPHANUM:/^(([a-z]|[A-Z])|[0-9])$/,MARK:/^(\-|\_|\!|\~|\(|\)|\$|\@)$/,STRING:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*$/,TOKEN:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+$/,INTEGER:/^([0-9])+$/,CHANNEL_SEGMENT:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+$/,CHANNEL_SEGMENTS:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*$/,CHANNEL_NAME:/^\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*$/,WILD_CARD:/^\*{1,2}$/,CHANNEL_PATTERN:/^(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*\/\*{1,2}$/,VERSION_ELEMENT:/^(([a-z]|[A-Z])|[0-9])(((([a-z]|[A-Z])|[0-9])|\-|\_))*$/,VERSION:/^([0-9])+(\.(([a-z]|[A-Z])|[0-9])(((([a-z]|[A-Z])|[0-9])|\-|\_))*)*$/,CLIENT_ID:/^((([a-z]|[A-Z])|[0-9]))+$/,ID:/^((([a-z]|[A-Z])|[0-9]))+$/,ERROR_MESSAGE:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*$/,ERROR_ARGS:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*(,(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)*$/,ERROR_CODE:/^[0-9][0-9][0-9]$/,ERROR:/^([0-9][0-9][0-9]:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*(,(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)*:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*|[0-9][0-9][0-9]::(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)$/},Faye.Extensible={addExtension:function(e){this._6=this._6||[],this._6.push(e),e.added&&e.added(this)},removeExtension:function(e){if(this._6)for(var t=this._6.length;t--;)this._6[t]===e&&(this._6.splice(t,1),e.removed&&e.removed(this))},pipeThroughExtensions:function(e,t,n,i){if(this.debug("Passing through ? extensions: ?",e,t),!this._6)return n.call(i,t);var r=this._6.slice(),s=function(t){if(!t)return n.call(i,t);var o=r.shift();return o?(o[e]?o[e](t,s):s(t),void 0):n.call(i,t)};s(t)}},Faye.extend(Faye.Extensible,Faye.Logging),Faye.Channel=Faye.Class({initialize:function(e){this.id=this.name=e},push:function(e){this.trigger("message",e)},isUnused:function(){return 0===this.countListeners("message")}}),Faye.extend(Faye.Channel.prototype,Faye.Publisher),Faye.extend(Faye.Channel,{HANDSHAKE:"/meta/handshake",CONNECT:"/meta/connect",SUBSCRIBE:"/meta/subscribe",UNSUBSCRIBE:"/meta/unsubscribe",DISCONNECT:"/meta/disconnect",META:"meta",SERVICE:"service",expand:function(e){var t=this.parse(e),n=["/**",e],i=t.slice();i[i.length-1]="*",n.push(this.unparse(i));for(var r=1,s=t.length;s>r;r++)i=t.slice(0,r),i.push("**"),n.push(this.unparse(i));return n},isValid:function(e){return Faye.Grammar.CHANNEL_NAME.test(e)||Faye.Grammar.CHANNEL_PATTERN.test(e)},parse:function(e){return this.isValid(e)?e.split("/").slice(1):null},unparse:function(e){return"/"+e.join("/")},isMeta:function(e){var t=this.parse(e);return t?t[0]===this.META:null},isService:function(e){var t=this.parse(e);return t?t[0]===this.SERVICE:null},isSubscribable:function(e){return this.isValid(e)?!this.isMeta(e)&&!this.isService(e):null},Set:Faye.Class({initialize:function(){this._2={}},getKeys:function(){var e=[];for(var t in this._2)e.push(t);return e},remove:function(e){delete this._2[e]},hasSubscription:function(e){return this._2.hasOwnProperty(e)},subscribe:function(e,t,n){if(t)for(var i,r=0,s=e.length;s>r;r++){i=e[r];var o=this._2[i]=this._2[i]||new Faye.Channel(i);o.bind("message",t,n)}},unsubscribe:function(e,t,n){var i=this._2[e];return i?(i.unbind("message",t,n),i.isUnused()?(this.remove(e),!0):!1):!1},distributeMessage:function(e){for(var t=Faye.Channel.expand(e.channel),n=0,i=t.length;i>n;n++){var r=this._2[t[n]];r&&r.trigger("message",e.data)}}})}),Faye.Publication=Faye.Class(Faye.Deferrable),Faye.Subscription=Faye.Class({initialize:function(e,t,n,i){this._7=e,this._2=t,this._m=n,this._n=i,this._y=!1},cancel:function(){this._y||(this._7.unsubscribe(this._2,this._m,this._n),this._y=!0)},unsubscribe:function(){this.cancel()}}),Faye.extend(Faye.Subscription.prototype,Faye.Deferrable),Faye.Client=Faye.Class({UNCONNECTED:1,CONNECTING:2,CONNECTED:3,DISCONNECTED:4,HANDSHAKE:"handshake",RETRY:"retry",NONE:"none",CONNECTION_TIMEOUT:60,DEFAULT_RETRY:5,DEFAULT_ENDPOINT:"/bayeux",INTERVAL:0,initialize:function(e,t){this.info("New client created for ?",e),this._f=t||{},this.endpoint=e||this.DEFAULT_ENDPOINT,this.endpoints=this._f.endpoints||{},this.transports={},this._E=Faye.CookieJar&&new Faye.CookieJar,this._z={},this._o=[],this.retry=this._f.retry||this.DEFAULT_RETRY,this._A(Faye.MANDATORY_CONNECTION_TYPES),this._1=this.UNCONNECTED,this._2=new Faye.Channel.Set,this._g=0,this._p={},this._8={reconnect:this.RETRY,interval:1e3*(this._f.interval||this.INTERVAL),timeout:1e3*(this._f.timeout||this.CONNECTION_TIMEOUT)},Faye.Event&&Faye.Event.on(Faye.ENV,"beforeunload",function(){Faye.indexOf(this._o,"autodisconnect")<0&&this.disconnect()},this)},disable:function(e){this._o.push(e)},setHeader:function(e,t){this._z[e]=t},getClientId:function(){return this._0},getState:function(){switch(this._1){case this.UNCONNECTED:return"UNCONNECTED";case this.CONNECTING:return"CONNECTING";case this.CONNECTED:return"CONNECTED";case this.DISCONNECTED:return"DISCONNECTED"}},handshake:function(e,t){if(this._8.reconnect!==this.NONE&&this._1===this.UNCONNECTED){this._1=this.CONNECTING;var n=this;this.info("Initiating handshake with ?",this.endpoint),this._9({channel:Faye.Channel.HANDSHAKE,version:Faye.BAYEUX_VERSION,supportedConnectionTypes:[this._a.connectionType]},function(i){if(i.successful){this._1=this.CONNECTED,this._0=i.clientId;var r=Faye.filter(i.supportedConnectionTypes,function(e){return Faye.indexOf(this._o,e)<0},this);this._A(r),this.info("Handshake successful: ?",this._0),this.subscribe(this._2.getKeys(),!0),e&&e.call(t)}else this.info("Handshake unsuccessful"),Faye.ENV.setTimeout(function(){n.handshake(e,t)},this._8.interval),this._1=this.UNCONNECTED},this)}},connect:function(e,t){if(this._8.reconnect!==this.NONE&&this._1!==this.DISCONNECTED){if(this._1===this.UNCONNECTED)return this.handshake(function(){this.connect(e,t)},this);this.callback(e,t),this._1===this.CONNECTED&&(this.info("Calling deferred actions for ?",this._0),this.setDeferredStatus("succeeded"),this.setDeferredStatus("deferred"),this._q||(this._q=!0,this.info("Initiating connection for ?",this._0),this._9({channel:Faye.Channel.CONNECT,clientId:this._0,connectionType:this._a.connectionType},this._B,this)))}},disconnect:function(){this._1===this.CONNECTED&&(this._1=this.DISCONNECTED,this.info("Disconnecting ?",this._0),this._9({channel:Faye.Channel.DISCONNECT,clientId:this._0},function(e){e.successful&&this._a.close()},this),this.info("Clearing channel listeners for ?",this._0),this._2=new Faye.Channel.Set)},subscribe:function(e,t,n){if(e instanceof Array)return Faye.map(e,function(e){return this.subscribe(e,t,n)},this);var i=new Faye.Subscription(this,e,t,n),r=t===!0,s=this._2.hasSubscription(e);return s&&!r?(this._2.subscribe([e],t,n),i.setDeferredStatus("succeeded"),i):(this.connect(function(){this.info("Client ? attempting to subscribe to ?",this._0,e),r||this._2.subscribe([e],t,n),this._9({channel:Faye.Channel.SUBSCRIBE,clientId:this._0,subscription:e},function(r){if(!r.successful)return i.setDeferredStatus("failed",Faye.Error.parse(r.error)),this._2.unsubscribe(e,t,n);var s=[].concat(r.subscription);this.info("Subscription acknowledged for ? to ?",this._0,s),i.setDeferredStatus("succeeded")},this)},this),i)},unsubscribe:function(e,t,n){if(e instanceof Array)return Faye.map(e,function(e){return this.unsubscribe(e,t,n)},this);var i=this._2.unsubscribe(e,t,n);i&&this.connect(function(){this.info("Client ? attempting to unsubscribe from ?",this._0,e),this._9({channel:Faye.Channel.UNSUBSCRIBE,clientId:this._0,subscription:e},function(e){if(e.successful){var t=[].concat(e.subscription);this.info("Unsubscription acknowledged for ? from ?",this._0,t)}},this)},this)},publish:function(e,t){var n=new Faye.Publication;return this.connect(function(){this.info("Client ? queueing published message to ?: ?",this._0,e,t),this._9({channel:e,data:t,clientId:this._0},function(e){e.successful?n.setDeferredStatus("succeeded"):n.setDeferredStatus("failed",Faye.Error.parse(e.error))},this)},this),n},receiveMessage:function(e){this.pipeThroughExtensions("incoming",e,function(e){if(e&&(e.advice&&this._F(e.advice),this._G(e),void 0!==e.successful)){var t=this._p[e.id];t&&(delete this._p[e.id],t[0].call(t[1],e))}},this)},_A:function(e){Faye.Transport.get(this,e,function(e){this.debug("Selected ? transport for ?",e.connectionType,e.endpoint),this._a=e,this._a.cookies=this._E,this._a.headers=this._z,e.bind("down",function(){(void 0===this._b||this._b)&&(this._b=!1,this.trigger("transport:down"))},this),e.bind("up",function(){void 0!==this._b&&this._b||(this._b=!0,this.trigger("transport:up"))},this)},this)},_9:function(e,t,n){e.id=this._H(),t&&(this._p[e.id]=[t,n]),this.pipeThroughExtensions("outgoing",e,function(e){e&&this._a.send(e,this._8.timeout/1e3)},this)},_H:function(){return this._g+=1,this._g>=Math.pow(2,32)&&(this._g=0),this._g.toString(36)},_F:function(e){Faye.extend(this._8,e),this._8.reconnect===this.HANDSHAKE&&this._1!==this.DISCONNECTED&&(this._1=this.UNCONNECTED,this._0=null,this._B())},_G:function(e){e.channel&&void 0!==e.data&&(this.info("Client ? calling listeners for ? with ?",this._0,e.channel,e.data),this._2.distributeMessage(e))},_I:function(){this._q&&(this._q=null,this.info("Closed connection for ?",this._0))},_B:function(){this._I();var e=this;Faye.ENV.setTimeout(function(){e.connect()},this._8.interval)}}),Faye.extend(Faye.Client.prototype,Faye.Deferrable),Faye.extend(Faye.Client.prototype,Faye.Publisher),Faye.extend(Faye.Client.prototype,Faye.Logging),Faye.extend(Faye.Client.prototype,Faye.Extensible),Faye.Transport=Faye.extend(Faye.Class({MAX_DELAY:0,batching:!0,initialize:function(e,t){this._7=e,this.endpoint=t,this._c=[]},close:function(){},send:function(e,t){return this.debug("Client ? sending message to ?: ?",this._7._0,this.endpoint,e),this.batching?(this._c.push(e),this._J=t,e.channel===Faye.Channel.HANDSHAKE?this.addTimeout("publish",.01,this.flush,this):(e.channel===Faye.Channel.CONNECT&&(this._r=e),this.shouldFlush&&this.shouldFlush(this._c)?this.flush():(this.addTimeout("publish",this.MAX_DELAY,this.flush,this),void 0))):this.request([e],t)},flush:function(){this.removeTimeout("publish"),this._c.length>1&&this._r&&(this._r.advice={timeout:0}),this.request(this._c,this._J),this._r=null,this._c=[]},receive:function(e){this.debug("Client ? received from ?: ?",this._7._0,this.endpoint,e);for(var t=0,n=e.length;n>t;t++)this._7.receiveMessage(e[t])},retry:function(e,t){var n=!1,i=1e3*this._7.retry,r=this;return function(){n||(n=!0,Faye.ENV.setTimeout(function(){r.request(e,t)},i))}}}),{MAX_URL_LENGTH:2048,get:function(e,t,n,i){var r=e.endpoint;void 0===t&&(t=this.supportedConnectionTypes()),Faye.asyncEach(this._s,function(s,o){var a=s[0],l=s[1],u=e.endpoints[a]||r;return Faye.indexOf(t,a)<0?(l.isUsable(e,u,function(){}),o()):(l.isUsable(e,u,function(t){if(!t)return o();var r=l.hasOwnProperty("create")?l.create(e,u):new l(e,u);n.call(i,r)}),void 0)},function(){throw new Error("Could not find a usable connection type for "+r)})},register:function(e,t){this._s.push([e,t]),t.prototype.connectionType=e},_s:[],supportedConnectionTypes:function(){return Faye.map(this._s,function(e){return e[0]})}}),Faye.extend(Faye.Transport.prototype,Faye.Logging),Faye.extend(Faye.Transport.prototype,Faye.Publisher),Faye.extend(Faye.Transport.prototype,Faye.Timeouts),Faye.Event={_h:[],on:function(e,t,n,i){var r=function(){n.call(i)};e.addEventListener?e.addEventListener(t,r,!1):e.attachEvent("on"+t,r),this._h.push({_i:e,_t:t,_m:n,_n:i,_C:r})},detach:function(e,t,n,i){for(var r,s=this._h.length;s--;)r=this._h[s],e&&e!==r._i||t&&t!==r._t||n&&n!==r._m||i&&i!==r._n||(r._i.removeEventListener?r._i.removeEventListener(r._t,r._C,!1):r._i.detachEvent("on"+r._t,r._C),this._h.splice(s,1),r=null)}},Faye.Event.on(Faye.ENV,"unload",Faye.Event.detach,Faye.Event),Faye.URI=Faye.extend(Faye.Class({queryString:function(){var e=[];for(var t in this.params)this.params.hasOwnProperty(t)&&e.push(encodeURIComponent(t)+"="+encodeURIComponent(this.params[t]));return e.join("&")},isSameOrigin:function(){var e=Faye.URI.parse(Faye.ENV.location.href),t=e.hostname!==this.hostname||e.port!==this.port||e.protocol!==this.protocol;return!t},toURL:function(){var e=this.queryString();return this.protocol+"//"+this.hostname+(this.port?":"+this.port:"")+this.pathname+(e?"?"+e:"")+this.hash}}),{parse:function(e,t){if("string"!=typeof e)return e;var n,i=new this,r=function(t,n,r){e=e.replace(n,function(e){return i[t]=e,""}),void 0===i[t]&&(i[t]=r?Faye.ENV.location[t]:"")};r("protocol",/^https?\:/,!0),r("host",/^\/\/[^\/]+/,!0),/^\//.test(e)||(e=Faye.ENV.location.pathname.replace(/[^\/]*$/,"")+e),r("pathname",/^\/[^\?#]*/),r("search",/^\?[^#]*/),r("hash",/^#.*/),/^\/\//.test(i.host)?(i.host=i.host.substr(2),n=i.host.split(":"),i.hostname=n[0],i.port=n[1]||""):(i.hostname=Faye.ENV.location.hostname,i.port=Faye.ENV.location.port);for(var s=i.search.replace(/^\?/,""),o=s?s.split("&"):[],a=o.length,l={};a--;)n=o[a].split("="),l[decodeURIComponent(n[0]||"")]=decodeURIComponent(n[1]||"");return"object"==typeof t&&Faye.extend(l,t),i.params=l,i}}),this.JSON||(JSON={}),function(){function l(e){return 10>e?"0"+e:e}function s(e){return o.lastIndex=0,o.test(e)?'"'+e.replace(o,function(e){var n=t[e];return"string"==typeof n?n:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function r(e,t){var n,i,o,a,l,u=m,c=t[e];switch(c&&"object"==typeof c&&"function"==typeof c.toJSON&&(c=c.toJSON(e)),"function"==typeof p&&(c=p.call(t,e,c)),typeof c){case"string":return s(c);case"number":return isFinite(c)?String(c):"null";case"boolean":case"null":return String(c);case"object":if(!c)return"null";if(m+=q,l=[],"[object Array]"===Object.prototype.toString.apply(c)){for(a=c.length,n=0;a>n;n+=1)l[n]=r(n,c)||"null";return o=0===l.length?"[]":m?"[\n"+m+l.join(",\n"+m)+"\n"+u+"]":"["+l.join(",")+"]",m=u,o}if(p&&"object"==typeof p)for(a=p.length,n=0;a>n;n+=1)i=p[n],"string"==typeof i&&(o=r(i,c),o&&l.push(s(i)+(m?": ":":")+o));else for(i in c)Object.hasOwnProperty.call(c,i)&&(o=r(i,c),o&&l.push(s(i)+(m?": ":":")+o));return o=0===l.length?"{}":m?"{\n"+m+l.join(",\n"+m)+"\n"+u+"}":"{"+l.join(",")+"}",m=u,o}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return this.getUTCFullYear()+"-"+l(this.getUTCMonth()+1)+"-"+l(this.getUTCDate())+"T"+l(this.getUTCHours())+":"+l(this.getUTCMinutes())+":"+l(this.getUTCSeconds())+"Z"},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var n=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,o=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,m,q,t={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},p;Faye.stringify=function(e,t,n){var i;if(m="",q="","number"==typeof n)for(i=0;n>i;i+=1)q+=" ";else"string"==typeof n&&(q=n);if(p=t,t&&"function"!=typeof t&&("object"!=typeof t||"number"!=typeof t.length))throw new Error("JSON.stringify");return r("",{"":e})},"function"!=typeof JSON.stringify&&(JSON.stringify=Faye.stringify),"function"!=typeof JSON.parse&&(JSON.parse=function(h,i){function j(e,t){var n,r,s=e[t];if(s&&"object"==typeof s)for(n in s)Object.hasOwnProperty.call(s,n)&&(r=j(s,n),void 0!==r?s[n]=r:delete s[n]);return i.call(e,t,s)}var k;if(n.lastIndex=0,n.test(h)&&(h=h.replace(n,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(h.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return k=eval("("+h+")"),"function"==typeof i?j({"":k},""):k;throw new SyntaxError("JSON.parse")})}(),Faye.Transport.WebSocket=Faye.extend(Faye.Class(Faye.Transport,{UNCONNECTED:1,CONNECTING:2,CONNECTED:3,batching:!1,isUsable:function(e,t){this.callback(function(){e.call(t,!0)}),this.errback(function(){e.call(t,!1)}),this.connect()},request:function(e){if(0!==e.length){this._d=this._d||{};for(var t=0,n=e.length;n>t;t++)this._d[e[t].id]=e[t];this.callback(function(t){t.send(Faye.toJSON(e))}),this.connect()}},close:function(){this._D||(this._D=!0,this._4&&this._4.close())},connect:function(){if(!Faye.Transport.WebSocket._K&&!this._D&&(this._1=this._1||this.UNCONNECTED,this._1===this.UNCONNECTED)){this._1=this.CONNECTING;var e=Faye.Transport.WebSocket.getClass();if(!e)return this.setDeferredStatus("failed");this._4=new e(Faye.Transport.WebSocket.getSocketUrl(this.endpoint));var t=this;this._4.onopen=function(){t._1=t.CONNECTED,t._u=!0,t.setDeferredStatus("succeeded",t._4),t.trigger("up")},this._4.onmessage=function(e){for(var n=[].concat(JSON.parse(e.data)),i=0,r=n.length;r>i;i++)delete t._d[n[i].id];t.receive(n)},this._4.onclose=function(){var e=t._1===t.CONNECTED;if(t.setDeferredStatus("deferred"),t._1=t.UNCONNECTED,delete t._4,e)return t.resend();if(!t._u)return t.setDeferredStatus("failed");var n=1e3*t._7.retry;Faye.ENV.setTimeout(function(){t.connect()},n),t.trigger("down")}}},resend:function(){if(this._d){var e=Faye.map(this._d,function(e,t){return t});this.request(e)}}}),{getSocketUrl:function(e){return Faye.URI&&(e=Faye.URI.parse(e).toURL()),e.replace(/^http(s?):/gi,"ws$1:")},getClass:function(){return Faye.WebSocket&&Faye.WebSocket.Client||Faye.ENV.WebSocket||Faye.ENV.MozWebSocket},isUsable:function(e,t,n,i){this.create(e,t).isUsable(n,i)},create:function(e,t){var n=e.transports.websocket=e.transports.websocket||{};return n[t]=n[t]||new this(e,t),n[t]}}),Faye.extend(Faye.Transport.WebSocket.prototype,Faye.Deferrable),Faye.Transport.register("websocket",Faye.Transport.WebSocket),Faye.Event&&Faye.Event.on(Faye.ENV,"beforeunload",function(){Faye.Transport.WebSocket._K=!0}),Faye.Transport.EventSource=Faye.extend(Faye.Class(Faye.Transport,{initialize:function(e,t){if(Faye.Transport.prototype.initialize.call(this,e,t),!Faye.ENV.EventSource)return this.setDeferredStatus("failed");this._L=new Faye.Transport.XHR(e,t);var n=new EventSource(t+"/"+e.getClientId()),i=this;n.onopen=function(){i._u=!0,i.setDeferredStatus("succeeded"),i.trigger("up")},n.onerror=function(){i._u?i.trigger("down"):(i.setDeferredStatus("failed"),n.close())},n.onmessage=function(e){i.receive(JSON.parse(e.data)),i.trigger("up")},this._4=n},isUsable:function(e,t){this.callback(function(){e.call(t,!0)}),this.errback(function(){e.call(t,!1)})},request:function(e,t){this._L.request(e,t)},close:function(){this._4.close()}}),{isUsable:function(e,t,n,i){var r=e.getClientId();return r?(Faye.Transport.XHR.isUsable(e,t,function(r){return r?(this.create(e,t).isUsable(n,i),void 0):n.call(i,!1)},this),void 0):n.call(i,!1)},create:function(e,t){var n=e.transports.eventsource=e.transports.eventsource||{};return n[t]=n[t]||new this(e,t),n[t]}}),Faye.extend(Faye.Transport.EventSource.prototype,Faye.Deferrable),Faye.Transport.register("eventsource",Faye.Transport.EventSource),Faye.Transport.XHR=Faye.extend(Faye.Class(Faye.Transport,{request:function(e,t){var n=this.retry(e,t),i=Faye.URI.parse(this.endpoint).pathname,r=this,s=Faye.ENV.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest;s.open("POST",i,!0),s.setRequestHeader("Content-Type","application/json"),s.setRequestHeader("Pragma","no-cache"),s.setRequestHeader("X-Requested-With","XMLHttpRequest");var o=this.headers;for(var a in o)o.hasOwnProperty(a)&&s.setRequestHeader(a,o[a]);var l=function(){s.abort()};Faye.Event.on(Faye.ENV,"beforeunload",l);var u=function(){Faye.Event.detach(Faye.ENV,"beforeunload",l),s.onreadystatechange=function(){},s=null};s.onreadystatechange=function(){if(4===s.readyState){var e=null,t=s.status,i=t>=200&&300>t||304===t||1223===t;if(!i)return u(),n(),r.trigger("down");try{e=JSON.parse(s.responseText)}catch(o){}u(),e?(r.receive(e),r.trigger("up")):(n(),r.trigger("down"))}},s.send(Faye.toJSON(e))}}),{isUsable:function(e,t,n,i){n.call(i,Faye.URI.parse(t).isSameOrigin())}}),Faye.Transport.register("long-polling",Faye.Transport.XHR),Faye.Transport.CORS=Faye.extend(Faye.Class(Faye.Transport,{request:function(e,t){var n=Faye.ENV.XDomainRequest?XDomainRequest:XMLHttpRequest,i=new n,r=this.retry(e,t),s=this;i.open("POST",this.endpoint,!0),i.setRequestHeader&&i.setRequestHeader("Pragma","no-cache");var o=function(){return i?(i.onload=i.onerror=i.ontimeout=i.onprogress=null,i=null,Faye.ENV.clearTimeout(l),!0):!1};i.onload=function(){var e=null;try{e=JSON.parse(i.responseText)}catch(t){}o(),e?(s.receive(e),s.trigger("up")):(r(),s.trigger("down"))};var a=function(){o(),r(),s.trigger("down")},l=Faye.ENV.setTimeout(a,1500*t);i.onerror=a,i.ontimeout=a,i.onprogress=function(){},i.send("message="+encodeURIComponent(Faye.toJSON(e)))}}),{isUsable:function(e,t,n,i){if(Faye.URI.parse(t).isSameOrigin())return n.call(i,!1);if(Faye.ENV.XDomainRequest)return n.call(i,Faye.URI.parse(t).protocol===Faye.URI.parse(Faye.ENV.location).protocol);if(Faye.ENV.XMLHttpRequest){var r=new Faye.ENV.XMLHttpRequest;return n.call(i,void 0!==r.withCredentials)}return n.call(i,!1)}}),Faye.Transport.register("cross-origin-long-polling",Faye.Transport.CORS),Faye.Transport.JSONP=Faye.extend(Faye.Class(Faye.Transport,{shouldFlush:function(e){var t={message:Faye.toJSON(e),jsonp:"__jsonp"+Faye.Transport.JSONP._v+"__"},n=Faye.URI.parse(this.endpoint,t).toURL();return n.length>=Faye.Transport.MAX_URL_LENGTH},request:function(e,t){var n={message:Faye.toJSON(e)},i=document.getElementsByTagName("head")[0],r=document.createElement("script"),s=Faye.Transport.JSONP.getCallbackName(),o=Faye.URI.parse(this.endpoint,n),a=this.retry(e,t),l=this;Faye.ENV[s]=function(e){c(),l.receive(e),l.trigger("up")};var u=Faye.ENV.setTimeout(function(){c(),a(),l.trigger("down")},1500*t),c=function(){if(!Faye.ENV[s])return!1;Faye.ENV[s]=void 0;try{delete Faye.ENV[s]}catch(e){}return Faye.ENV.clearTimeout(u),r.parentNode.removeChild(r),!0};o.params.jsonp=s,r.type="text/javascript",r.src=o.toURL(),i.appendChild(r)}}),{_v:0,getCallbackName:function(){return this._v+=1,"__jsonp"+this._v+"__"
},isUsable:function(e,t,n,i){n.call(i,!0)}}),Faye.Transport.register("callback-polling",Faye.Transport.JSONP),function(){var e,t,n=[].slice,i=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1},r={}.hasOwnProperty,s=function(e,t){function n(){this.constructor=e}for(var i in t)r.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};null==(t=this.Kamino)&&(this.Kamino={}),e=function(){var e,t;return this.Log={trace:!0,logPrefix:"App",log:function(){var e;return e=1<=arguments.length?n.call(arguments,0):[],this.trace?(this.logPrefix&&e.unshift("["+this.logPrefix+"]"),"undefined"!=typeof console&&null!==console&&"function"==typeof console.log&&console.log.apply(console,e),this):void 0}},this.framework=function(){return jQuery},this.Events={on:function(e,t){var n,i,r,s,o;for(i=e.split(" "),n=this.hasOwnProperty("_callbacks")&&this._callbacks||(this._callbacks={}),s=0,o=i.length;o>s;s++)r=i[s],n[r]||(n[r]=[]),n[r].push(t);return this},off:function(e,t){var n,i,r,s,o,a;if(!e)return this._callbacks={},this;if(r=null!=(a=this._callbacks)?a[e]:void 0,!r)return this;if(!t)return delete this._callbacks[e],this;for(i=s=0,o=r.length;o>s;i=++s)if(n=r[i],n===t){r=r.slice(),r.splice(i,1),this._callbacks[e]=r;break}return this},trigger:function(){var e,t,i,r,s,o,a;if(e=1<=arguments.length?n.call(arguments,0):[],i=e.shift(),r=this.hasOwnProperty("_callbacks")&&(null!=(a=this._callbacks)?a[i]:void 0)){for(s=0,o=r.length;o>s&&(t=r[s],t.apply(this,e)!==!1);s++);return!0}}},this.TextHelper={htmlEscapeMapping:{"&":"&amp;",">":"&gt;","<":"&lt;",'"':"&quot;"},markupMapping:{"*":"strong",_:"em"},htmlEscape:function(e){var t,n,i;i=this.htmlEscapeMapping;for(t in i)n=i[t],e=e.replace(new RegExp(t,"g"),n);return e},simpleMarkup:function(e){var t,n,i,r;r=this.markupMapping;for(t in r)i=r[t],n=new RegExp("\\"+t+"([^"+t+"\\n]*)\\"+t,"g"),e=e.replace(n,"<"+i+">$1</"+i+">");return e},simpleFormat:function(e){return e="<p>"+e,e=e.replace(/\r\n?/g,"\n"),e=e.replace(/\n\n+/g,"</p>\n\n<p>"),e=e.replace(/(\n+)(?=[^\n])/g,"<br>"),e+"</p>"},linkify:function(e){var t;return t=new RegExp("((https?://|www.)[^\\s'\"<>()]+)","ig"),e=e.replace(t,'<a target="_blank" href="$1" class="linkified">$1</a>'),e=e.replace(new RegExp('href="www.',"ig"),'href="http://www.'),e=e.replace(new RegExp('([^a-z0-9]+)" class="linkified">',"ig"),'">'),e=e.replace(new RegExp("([^a-z0-9/]+)</a>","ig"),"</a>$1"),e=e.replace(new RegExp(' class="linkified"',"ig"),"")}},t=["extended","included"],this.Module=function(){function e(){}return e.extend=function(e){var n,r,s;for(n in e)r=e[n],i.call(t,n)<0&&(this[n]=r);return null!=(s=e.extended)&&s.apply(this),this},e.include=function(e){var n,r,s;for(n in e)r=e[n],i.call(t,n)<0&&(this.prototype[n]=r);return null!=(s=e.included)&&s.apply(this),this},e.prototype.extend=function(e){return Kamino.Module.extend.call(this,e)},e.prototype.proxy=function(e){var t=this;return function(){return e.apply(t,arguments)}},e}(),this.Model=function(e){function t(e){var t,n;for(t in e)n=e[t],this[t]=n}return s(t,e),t.extend(Kamino.Log),t.logPrefix="Model",t._records=null,t.on=function(){var e,t;return e=1<=arguments.length?n.call(arguments,0):[],this.log("Kamino.Model.on is deprecated, use Collection#on"),this.initializeCollection(),(t=this._records).on.apply(t,e)},t.off=function(){var e,t;return e=1<=arguments.length?n.call(arguments,0):[],this.log("Kamino.Model.off is deprecated, use Collection#off"),this.initializeCollection(),(t=this._records).off.apply(t,e)},t.trigger=function(){var e,t;return e=1<=arguments.length?n.call(arguments,0):[],this.log("Kamino.Model.trigger is deprecated, use Collection#trigger"),this.initializeCollection(),(t=this._records).trigger.apply(t,e)},t.refresh=function(e){return this.log("Kamino.Model.refresh is deprecated, use Collection#refresh"),this.initializeCollection(),this._records.refresh(e)},t.each=function(e){return this.log("Kamino.Model.each is deprecated, use Collection#each"),this.initializeCollection(),this._records.each(e)},t.all=function(){return this.log("Kamino.Model.all is deprecated, use Collection#all"),this.initializeCollection(),this._records.all()},t.last=function(){return this.log("Kamino.Model.last is deprecated, use Collection#last"),this.initializeCollection(),this._records.last()},t.find=function(e){return this.log("Kamino.Model.find is deprecated, use Collection#find"),initializeCollection(),this._records.find(e,callback)},t.create=function(e){return this.log("Kamino.Model.create is deprecated, use Collection#create"),this.initializeCollection(),this._records.create(e)},t.fromJSON=function(e){return this.log("Kamino.Model.fromJSON is deprecated, use Collection#fromJSON"),this.initializeCollection(),this._records.fromJSON(e)},t.initializeCollection=function(){var e;return null!=(e=this._records)?e:this._records=new Kamino.Collection({model:this})},t.prototype.trigger=function(){var e,t;return e=1<=arguments.length?n.call(arguments,0):[],e.splice(1,0,this),(t=this._collection).trigger.apply(t,e)},t.prototype.attributes=function(){var e,t,n,i;t={};for(e in this)n=this[e],("string"==(i=typeof n)||"number"===i)&&(t[e]=n);return t},t.prototype.update=function(e){var t,n;for(t in e)n=e[t],this[t]=n;return this.trigger("update")},t.prototype.toJSON=function(){return this.attributes()},t}(this.Module),this.Collection=function(e){function t(e){null==e&&(e={}),this.model=e.model||this.constructor.model,this.order=e.order,this.records=[]}return s(t,e),t.include(Kamino.Events),t.model=Kamino.Model,t.prototype.refresh=function(e){return this.records=this.fromJSON(e),this.trigger("refresh"),this},t.prototype.append=function(e){var t,n,i,r;for(r=this.fromJSON(e),n=0,i=r.length;i>n;n++)t=r[n],this.records.push(t);return this.trigger("refresh")},t.prototype.each=function(e){var t,n,i,r,s,o;for(s=this.records,o=[],t=i=0,r=s.length;r>i;t=++i)n=s[t],o.push(e(n,t));return o},t.prototype.all=function(){return this.records},t.prototype.last=function(){return this.records[this.records.length-1]},t.prototype.find=function(e){var t,n,i,r;for(r=this.records,n=0,i=r.length;i>n;n++)if(t=r[n],t.id===e)return t},t.prototype.create=function(e){var t;return t=this._prepareModel(e),this.records.push(t),t.trigger("create"),t},t.prototype.fromJSON=function(e){var t,n,i,r;if(!e)return[];for(r=[],n=0,i=e.length;i>n;n++)t=e[n],r.push(this._prepareModel(t));return r},t.prototype._prepareModel=function(e){var t;return null==e&&(e={}),e._collection=this,t=new this.model(e)},t}(this.Module),this.Sync={sync:function(e,t){var n=this;return this.new_record=!0,e.connection().postMessage(this.toJSON(),function(i,r){return i?"function"==typeof t?t(i):void 0:(n._collection=e,n.update(r),n._collection.findMessageOrReply(n.id)||n._collection.insert(n),n.new_record=!1,t())})}},this.Token={parse:function(e){return JSON.parse(JSON.parse(window.atob(e)).data)}},this.Util={Array:{remove:function(e,t){var n,i;return(n=Kamino.Util.Array.indexOf(e,t))>-1?([].splice.apply(e,[n,n-n+1].concat(i=[])),i):void 0},indexOf:function(e,t){var n,i,r,s;if(Array.prototype.indexOf)return e.indexOf(t);for(i=r=0,s=e.length;s>r;i=++r)if(n=e[i],n===t)return i;return-1}},Ajax:{getJSON:function(e,t){return Kamino.Util.Ajax.request(e,null,t)},post:function(e,t,n){return Kamino.Util.Ajax.request(e,Kamino.Util.param(t),n)},"delete":function(e,t){return Kamino.Util.Ajax.request(e,"_method=delete",t)},request:function(e,t,n){var i,r,s,o;return o=new Kamino.Util.Ajax.xhrClass,o.onload=function(){var e;if(!/^2\d{2}$/.test(o.status))return"function"==typeof n?n(new Error("Client Error")):void 0;try{return"function"==typeof n?n(null,Kamino.Util.trim(o.responseText)?JSON.parse(o.responseText):o.responseText):void 0}catch(t){return e=t,"function"==typeof n?n(new Error("SyntaxError: Unable to parse JSON string")):void 0}},o.onerror=function(){return"function"==typeof n?n(new Error("Request could not be completed.")):void 0},i=null!=t?"POST":"GET",Kamino.Util.Ajax.forceHttpOk?(s=""+e+"&force_http_ok=true",r=o.onload,o.onload=function(){return o=new Kamino.Util.Ajax.WrappedXhrResponse(o.responseText),r()}):s=e,o.open(i,s,!0),t&&"function"==typeof o.setRequestHeader&&o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.onprogress=function(){},o.send(t)},xhrClass:window.XDomainRequest?XDomainRequest:XMLHttpRequest,forceHttpOk:window.XDomainRequest?!0:!1,WrappedXhrResponse:e=function(){function e(e){var t;t=JSON.parse(e),this.status=t.status,this.responseText=t.body}return e}()},param:function(e){var t,n,i,r;r=[],t=function(e,t){return r.push(encodeURIComponent(e)+"="+encodeURIComponent(t))},n=function(e,i){var r,s,o;if(null!=i&&"object"==typeof i){o=[];for(r in i)s=i[r],o.push(n(""+e+"["+r+"]",s));return o}return t(e,i)};for(i in e)n(i,e[i]);return r.join("&").replace(/%20/g,"+")},parseDate:function(e){var t,n,i;if(n=[1,4,5,6,7,10,11],t=0,i=/^(\d{4}|[+\-]\d{6})(?:-(\d{2})(?:-(\d{2}))?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{3}))?)?(?:(Z)|([+\-])(\d{2})(?::(\d{2}))?)?)?$/.exec(e)){for(var r,s=0;r=n[s];++s)i[r]=+i[r]||0;return i[2]=(+i[2]||1)-1,i[3]=+i[3]||1,"Z"!==i[8]&&void 0!==i[9]&&(t=60*i[10]+i[11],"+"===i[9]&&(t=0-t)),Date.UTC(i[1],i[2],i[3],i[4],i[5]+t,i[6],i[7])}return Date.parse(e)},dateToIsoString:function(e){var t;return"toISOString"in e?e.toISOString():(t=function(e){return 10>e?0+e:e},e.getUTCFullYear()+"-"+t(e.getUTCMonth()+1)+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+String((e.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z")},trim:function(e){return String.prototype.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}}},e.call(Kamino)}.call(this),function(){var e,t,n={}.hasOwnProperty,i=function(e,t){function i(){this.constructor=e}for(var r in t)n.call(t,r)&&(e[r]=t[r]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e},r=[].slice;null==(t=this.Kamino)&&(this.Kamino={}),e=function(){var e,t;return this.Employee=function(t){function n(){return e=n.__super__.constructor.apply(this,arguments)}return i(n,t),n.prototype.photoWithMissing=function(e){var t,n;return n="M"===this.gender?"mens":"womens",t=this.external_id%8+1,null==e&&(e="https://admin.mijnio.nl/assets/dossier/avatars/"+n+"/"+t+".png"),""+this.photo+"&missing="+encodeURIComponent(e)},n}(this.Model),this.Team=function(e){function n(){return t=n.__super__.constructor.apply(this,arguments)}return i(n,e),n}(this.Model),this.Message=function(e){function t(e){t.__super__.constructor.apply(this,arguments),this.wrapAttributes(e)}return i(t,e),t.include(Kamino.TextHelper),t.include(Kamino.Sync),t.extend(Kamino.Log),t.logPrefix="Message",t.create=function(){var e,t;return e=1<=arguments.length?r.call(arguments,0):[],this.log("Kamino.Message.create is deprecated, use client.messages.create"),this.initializeCollection(),(t=this._records).create.apply(t,e)},t.insert=function(e){return this.log("Kamino.Message.insert is deprecated, use client.messages.insert"),this.initializeCollection(),this._records.insert(e)},t.find=function(e){return this.log("Kamino.Message.find is deprecated, use client.messages.find"),this.initializeCollection(),this._records.find(e)},t.findMessageOrReply=function(e){return this.log("Kamino.Message.findMessageOrReply is deprecated, use client.messages.findMessageOrReply"),this.initializeCollection(),this._records.findMessageOrReply(e)},t.initializeCollection=function(){var e;return null!=(e=this._records)?e:this._records=new Kamino.MessageCollection},t.prototype.wrapAttributes=function(e){var n,i,r,s,o,a,l,u;if(e.created_at&&(this.created_at=new Date(Kamino.Util.parseDate(e.created_at))),e.updated_at&&(this.updated_at=new Date(Kamino.Util.parseDate(e.updated_at))),e.sender&&(this.sender=new Kamino.Employee(e.sender)),e.body&&(this._formattedBody=null),e.replies){for(this.replies=[],a=e.replies,i=0,s=a.length;s>i;i++)n=a[i],this.replies.push(new t(n));for(l=this.replies,u=[],r=0,o=l.length;o>r;r++)n=l[r],u.push(n._collection=e._collection);return u}},t.prototype.formatBody=function(){return this._formattedBody||(this._formattedBody=this.linkify(this.simpleFormat(this.simpleMarkup(this.htmlEscape(this.body)))))},t.prototype.sentDirectlyToMe=function(){return"employee"===this.recipient.recipient_type&&this.recipient.id.toString()===this._collection.currentEmployeeId().toString()},t.prototype.writtenByMe=function(){return this.sender.id===this._collection.currentEmployeeId()},t.prototype.thread=function(){return this._collection.find(this.thread_id)},t.prototype.update=function(e){return t.__super__.update.apply(this,arguments),this.wrapAttributes(e),!this.new_record&&e.updated_at&&null==this.thread_id?this._collection.sortIfOrderIsUpdated():void 0},t.prototype.markRead=function(e){var t,n;return null==e&&(e={}),t=null!=(n=this.thread())?n:this,(e.force||!this.readByMe())&&t.trigger("read",e),this},t.prototype.readByMe=function(){var e,t,n;return t=null!=(n=this.thread())?n:this,e=t.read_by[this._collection.currentEmployeeId()],null!=e&&Kamino.Util.parseDate(e)>=Kamino.Util.parseDate(t.updated_at)},t.prototype.isNewThread=function(){return null!=this.thread_id||this.writtenByMe()?!1:!this.read_by[this._collection.currentEmployeeId()]},t.prototype.hasNewReply=function(){var e;return null!=this.thread_id||this.lastReplyWrittenByMe()||!this.replies.length?!1:(e=this.read_by[this._collection.currentEmployeeId()],!e||Kamino.Util.parseDate(e)<Kamino.Util.parseDate(this.updated_at))},t.prototype.lastReplyWrittenByMe=function(){return this.replies&&this.replies[this.replies.length-1]&&this.replies[this.replies.length-1].writtenByMe()},t.prototype.destroy=function(e,t){return null==e&&(e={}),null!=this.thread_id?Kamino.Util.Array.remove(this.thread().replies,this):this._collection.remove(this),this.destroyed=!0,this.trigger("destroy",e),e.noSync?"function"==typeof t&&t():this._collection.connection().destroyMessage(this.id,t),this},t}(this.Model),this.MessageCollection=function(e){function t(e,n){this.client=e,null==n&&(n={}),t.__super__.constructor.apply(this,arguments)}return i(t,e),t.model=Kamino.Message,t.prototype.create=function(e){var t;return t=this._prepareModel(e),this.insert(t)},t.prototype.insert=function(e){return null!=e.thread_id?e.thread()&&e.thread().replies.push(e):this.records.unshift(e),e.trigger("create"),e},t.prototype.find=function(e){return this.findMessageOrReply(e)},t.prototype.findMessageOrReply=function(e){var t,n,i,r,s,o,a,l;for(a=this.records,i=0,s=a.length;s>i;i++){if(t=a[i],t.id===e)return t;if(t.replies)for(l=t.replies,r=0,o=l.length;o>r;r++)if(n=l[r],n.id===e)return n}return null},t.prototype.remove=function(e){return Kamino.Util.Array.remove(this.records,e)},t.prototype.sortIfOrderIsUpdated=function(){return"updated"===this.order?this.sort():void 0},t.prototype.sort=function(){var e;return e=""+this.order+"_at",this.records=this.records.sort(function(t,n){return t[e]<n[e]?1:-1}),this.trigger("refresh")},t.prototype.currentEmployeeId=function(){return this.client.employee_id},t.prototype.connection=function(){return this.client.connection},t}(this.Collection),this.Connection=function(){function e(e,t,n,i){this.token=e,this.limit=null!=t?t:5,this.order=null!=n?n:"created",this.searchOptions=null!=i?i:{}}return e.prototype.host="https://kamino.ons.io",e.prototype.getMessages=function(e,t){return null==t&&(t={}),Kamino.Util.Ajax.getJSON(this.messagesPath(t),e)},e.prototype.getMessage=function(e,t){return Kamino.Util.Ajax.getJSON(this.messagesPath({id:e}),t)},e.prototype.postMessage=function(e,t){return Kamino.Util.Ajax.post(this.messagesPath(),{message:e},t)},e.prototype.destroyMessage=function(e,t){return Kamino.Util.Ajax["delete"](this.messagesPath({id:e}),t)},e.prototype.markMessageRead=function(e){return Kamino.Util.Ajax.post(this.readMessagePath({id:e}),{})},e.prototype.messagesPath=function(e){var t,n,i;return null==e&&(e={}),t=e.id?"/"+e.id:"",n=t?"":"limit="+this.limit+"&",i=t?"":"order="+this.order+"&",e.before&&(n+="before="+Kamino.Util.dateToIsoString(e.before)+"&"),""+this.host+"/messages"+t+".json?"+n+i+"token="+this.token},e.prototype.readMessagePath=function(e){return null==e&&(e={}),""+this.host+"/messages/"+e.id+"/read?token="+this.token},e.prototype.searchEmployees=function(e,t){return Kamino.Util.Ajax.getJSON(this.employeesSearchPath(e),t)},e.prototype.employeesSearchPath=function(e){return""+this.host+"/employees/search.json?q="+e+"&token="+this.token+(this.searchOptions.employeeLimit?"&limit="+this.searchOptions.employeeLimit:"")},e.prototype.searchTeams=function(e,t){return Kamino.Util.Ajax.getJSON(this.teamsSearchPath(e),t)},e.prototype.teamsSearchPath=function(e){return""+this.host+"/teams/search.json?q="+e+"&token="+this.token+(this.searchOptions.teamLimit?"&limit="+this.searchOptions.teamLimit:"")},e}(),this.Client=function(e){function t(e,t){var i,r,s=this;null==t&&(t={}),this.order=t.order||"created",this.fetchIfMissing="created"!==this.order,this.searchOptions=t.searchOptions||{},this.connection=new Kamino.Connection(e,t.limit,this.order,this.searchOptions),this.messages=new Kamino.MessageCollection(this,{order:this.order}),this.data={Message:this.messages},Kamino.Message._records=this.messages,this.messages.on("read",function(e,t){return null==t&&(t={}),t.noSync?void 0:(e.read_by[s.employee_id]=(new Date).toString(),s.connection.markMessageRead(e.id))}),this.extend(Kamino.Token.parse(e)),"object"==typeof window.Faye?(i=new Faye.Client("https://kamino-push.ons.io/faye",{timeout:120}),i.addExtension(new n(e)),r=i.subscribe(this.userChannel(),this.proxy(this.handlePushEvent))):this.log("Warning, push service unavailable"),Kamino.Message.kamino=this}var n;return i(t,e),t.include(Kamino.Log),t.prototype.logPrefix="Client",t.prototype.on=function(e,t,n){return this.data[e].on(t,n)},t.prototype.each=function(e,t){return this.data[e].each(t)},t.prototype.fetch=function(e){var t=this;return this.connection.getMessages(function(n,i){return n?"function"==typeof e?e(n):void 0:(t.messages.refresh(i),"function"==typeof e?e():void 0)})},t.prototype.fetchMore=function(e){var t,n=this;return this.connection.getMessages(function(t,i){return t?"function"==typeof e?e(t):void 0:(n.messages.append(i),"function"==typeof e?e():void 0)},{before:null!=(t=this.messages.last())?t[""+this.order+"_at"]:void 0})},t.prototype.fetchOne=function(e,t){var n=this;return this.connection.getMessage(e,function(e,i){return e?"function"==typeof t?t(e):void 0:(n.messages.create(i),"function"==typeof t?t():void 0)})},t.prototype.postTeamMessage=function(e,t,n){var i;return i=new Kamino.Message({body:e,recipient_type:"team"}),t&&(i.recipient_id=t),i.sync(this.messages,n)},t.prototype.postEmployeeMessage=function(e,t,n){var i;return i=new Kamino.Message({body:e,recipient_type:"employee",recipient_id:t}),i.sync(this.messages,n)},t.prototype.postReplyMessage=function(e,t,n){var i;return i=new Kamino.Message({body:e,thread_id:t}),i.sync(this.messages,n)},t.prototype.searchEmployees=function(e,t){return this.connection.searchEmployees(e,function(e,n){var i,r;return e?t(e):(r=function(){var e,t,r;for(r=[],e=0,t=n.length;t>e;e++)i=n[e],r.push(new Kamino.Employee(i));return r}(),t(null,r))})},t.prototype.searchTeams=function(e,t){return this.connection.searchTeams(e,function(e,n){var i,r;return e?t(e):(i=function(){var e,t,i;for(i=[],e=0,t=n.length;t>e;e++)r=n[e],i.push(new Kamino.Team(r));return i}(),t(null,i))})},t.prototype.searchAll=function(e,t){var n,i,r;return i=r=null,n=function(e){return e?t(e):i&&r?t(null,i,r):void 0},this.searchEmployees(e,function(e,t){return i=t,n(e)}),this.searchTeams(e,function(e,t){return r=t,n(e)})},t.prototype.destroyMessage=function(e,t){var n;return n=this.messages.findMessageOrReply(e),this.log(["destroyMessage: ",n]),n?n.destroy({},t):void 0},t.prototype.userChannel=function(){return"/care_providers/"+this.customer_code+"/employees/"+this.employee_id},t.prototype.handlePushEvent=function(e){var t;if(this.log("faye push",e),this.data[e.klass]){if(t=this.data[e.klass].find(e.id),t&&"destroy"===e.type)return t.destroy({noSync:!0});if(!t&&"create"===e.type)return this.data[e.klass].create(e.record);if("update"===e.type){if(t)return t.update(e.record);if(this.fetchIfMissing)return this.fetchOne(e.id)}}},n=function(){function e(e){this.token=e}return e.prototype.outgoing=function(e,t){var n;return"/meta/subscribe"!==e.channel?t(e):(null==(n=e.ext)&&(e.ext={}),e.ext.token=this.token,t(e))},e}(),t}(this.Module)},e.call(Kamino)}.call(this),function(){var e;e=function(){return this.ChatApplication=function(){function e(){t.available()&&t.versionRequirementMet()?(window.k$=jQuery,this.initialize()):t.load(this)}var t,n,i,r;return r={teams:[["My team","team"]],tagPrefix:"kamino",token:null},i={en:{header:"MESSAGE BOARD",noMessages:"There aren't any messages. Send your first message to a team or colleague by clicking on the 'new message' button below.",postNewMessageButton:"New message",cancelButton:"Cancel",backButton:"Back",recipientPlaceholder:"Who do you want to reach?",emptyBodyAlert:"Oops, you need to type a message first before you can send it!",emptyRecipientAlert:"Oops, you need to select a recipient first!",to:"to","new":"NEW",send:"Send",respond:"Respond",updated:"NEW REPLY",replyCount:"%d replies",noReplies:"no replies",remove:"remove message",deleteConfirm:"Are you sure you want to delete this message?",inReplyTo:"To:",myTeamDefault:"This message will be sent to %s",employee:"person",employees:"people",popupNotificationTeamSearch:"You can now easily send messages to other teams within your care provider. Just type the name of the team you want to reach, and select the desired team.",timeago:{prefixAgo:null,prefixFromNow:null,suffixAgo:"ago",suffixFromNow:"from now",seconds:"less than a minute",minute:"about a minute",minutes:"%d minutes",hour:"about an hour",hours:"about %d hours",day:"a day",days:"%d days",month:"about a month",months:"%d months",year:"about a year",years:"%d years",numbers:[]}},nl:{header:"BERICHTEN",noMessages:"Er zijn nog geen berichten. Stuur je eerste bericht naar een team of collega door hieronder op de knop 'nieuw bericht' te klikken.",postNewMessageButton:"Nieuw bericht",cancelButton:"Annuleren",backButton:"Terug",recipientPlaceholder:"Wie wil je bereiken?",emptyBodyAlert:"Oeps, je moet eerst een bericht typen!",emptyRecipientAlert:"Oeps, je moet eerst een ontvanger selecteren!",to:"aan","new":"NIEUW",send:"Verstuur",respond:"Reageer",updated:"NIEUWE REACTIE",replyCount:"%d reacties",noReplies:"geen reacties",remove:"verwijder bericht",deleteConfirm:"Weet je zeker dat je dit bericht wilt verwijderen?",inReplyTo:"Aan:",myTeamDefault:"Dit bericht wordt verzonden naar %s",employee:"persoon",employees:"personen",popupNotificationTeamSearch:"Je kunt nu ook makkelijk een bericht sturen naar andere teams binnen je zorginstelling. Typ de naam van het team dat je wilt bereiken in en selecteer vervolgens het gewenste team.",timeago:{suffixAgo:"geleden",suffixFromNow:"vanaf nu",seconds:"minder dan een minuut",minute:"ongeveer een minuut",minutes:"%d minuten",hour:"ongeveer een uur",hours:"ongeveer %d uur",day:"een dag",days:"%d dagen",month:"ongeveer een maand",months:"%d maanden",year:"ongeveer een jaar",years:"%d jaar",numbers:[]}}},n=function(){function e(e,t){this.settings=e,this.client=t}var t,n,i,r;return r=!1,n=410,t=442,i=function(){var e,t=this;return e=0,function(e,n){return clearTimeout(t.timer),t.timer=setTimeout(e,n)}}(),e.prototype.initialize=function(){return 0!==this.getElement("stylesheet").length?(this.build(),this.setupEvents()):(this.setupStyleSheet("https://kamino.ons.io/assets/chat_application.css","window.chatApplication.ui.initialize()"),null!=this.settings.cssFile?this.setupStyleSheet(this.settings.cssFile):void 0)},e.prototype.setupStyleSheet=function(e,t){var n,i,r,s;return s={href:e,type:"text/css",media:"screen,print",charset:"utf-8",rel:"stylesheet"},null!=t&&(s.onload=t),n=this.buildElement("link","stylesheet",s),"onload"in n[0]&&!this.isSafari5()||(r={src:e},null!=t&&(r.onerror=t),i=this.buildElement("img","lazy_loader",r)),k$("head").append(n)},e.prototype.isSafari5=function(){return!!navigator.userAgent.match(" Safari/")&&!navigator.userAgent.match(" Chrom")&&!!navigator.userAgent.match(" Version/5.")},e.prototype.toggleVisibility=function(){var e,t,n=this;return e=this.getElement("main"),r?e.animate({bottom:-10},150,function(){return n.getElement("content").show(),e.css("bottom","-="+(k$(".kamino_content").height()+2)+"px",0),e.animate({bottom:-10},function(){return e.animate({bottom:-35},150,function(){var t;return t=n.getElement("content").height()-n.contentHeightWhenVisible,e.css("bottom","+="+t+"px"),n.getElement("content").height(n.contentHeightWhenVisible)})})}):(t=this.contentHeightWhenNotVisible-this.getElement("content").height(),e.css("bottom","-="+t+"px"),this.getElement("content").height(this.contentHeightWhenNotVisible),e.animate({bottom:0},150,function(){return e.animate({bottom:-e.height()+10},400,function(){return e.css("bottom","+="+(k$(".kamino_content").height()+2)+"px",0),n.getElement("content").hide(),e.animate({bottom:1},150)})}))},e.prototype.setupEvents=function(){return this.setupBaseEvents(),this.setupMessageEvents(),this.setupReplyEvents(),this.setupAutoCompleteEvents()},e.prototype.removeExistingEvents=function(){return"function"==typeof window.jQuery?window.jQuery("."+this.settings.tagPrefix+"_main input, ."+this.settings.tagPrefix+"_main textarea").unbind():void 0},e.prototype.setupBaseEvents=function(){var e=this;return this.getElement("messages").scroll(function(){var t;return t=e.getElement("messages"),t.prop("scrollHeight")===t.scrollTop()+t.height()?e.client.fetchMore():void 0}),this.getElement("header").live("click",function(){return e.removeExistingEvents(),r=!r,e.toggleVisibility()})},e.prototype.setupMessageEvents=function(){var e=this;return this.getElement("remove_message").live("click",function(t){var n;return confirm(e.settings.locale.deleteConfirm)&&(n=k$(t.currentTarget).data("message-id"),e.client.destroyMessage(n)),!1}),this.getElement("new_message").live("click",function(){return e.setDefaultAutoComplete(),e.getElement("message_list").animate({opacity:0}),e.getElement("vertical_slider").animate({top:-510},400,function(){return e.getElement("body").focus()})}),this.getElement("cancel_button").live("click",function(){return e.resetPostNewMessage(),e.resetPostNewReply()}),this.getElement("message").live("click",function(t){var n,i;return n=k$(t.currentTarget),n.hasClass(""+e.settings.tagPrefix+"_full_message")?void 0:(i=n.data("message"),i.markRead(),n.find("."+e.settings.tagPrefix+"_new, ."+e.settings.tagPrefix+"_updated").remove(),e.updateCounter(),e.buildRepliesForMessage(i),e.getElement("horizontal_slider").animate({left:-390},400))}),this.getElement("post_new_message_button").live("click",function(){return null==e.getElement("recipient").data("recipient")?alert(e.settings.locale.emptyRecipientAlert):""===k$.trim(e.getElement("body").val())?alert(e.settings.locale.emptyBodyAlert):e.resetPostNewMessage(function(){var t,n,i;return e.getElement("messages").animate({scrollTop:0}),n=e.getElement("recipient").data("recipient"),i=e.getElement("recipient").data("recipient_type"),t=e.getElement("body").val(),"team"===n?e.client.postTeamMessage(t):"team"===i?e.client.postTeamMessage(t,n):e.client.postEmployeeMessage(t,n)})})},e.prototype.setupReplyEvents=function(){var e=this;return this.getElement("back_button").live("click",function(){return e.getElement("message_replies_list").fadeOut(function(){return k$(this).remove()}),e.getElement("horizontal_slider").animate({left:0},500),e.getElement("post_new_message").show(),e.getElement("post_new_reply").remove()}),this.getElement("new_reply_button").live("click",function(t){var n,i;return n=k$(t.currentTarget),i=n.data("message"),e.getElement("post_new_reply").length||e.buildNewReplyForMessage(i),e.getElement("post_new_message").hide(),e.getElement("post_new_reply").show(),e.getElement("vertical_slider").animate({top:-510},400,function(){return e.getElement("reply_body").focus()})}),this.getElement("post_new_reply_button").live("click",function(t){var n;return n=e.getElement("reply_body").val(),""===k$.trim(n)?alert(e.settings.locale.emptyBodyAlert):e.resetPostNewReply(function(){return e.getElement("messages").animate({scrollTop:0}),e.client.postReplyMessage(n,k$(t.currentTarget).data("message").id)})})},e.prototype.setupAutoCompleteEvents=function(){var e=this;return this.getElement("recipient").live("click",function(t){var n;return n=k$(t.currentTarget),n.val(""),e.resetAutocomplete(),e.getElement("popup").show(),e.removePopupNotification()}),this.getElement("body").live("focus",function(){return e.getElement("popup").hide()}),this.getElement("recipient").live("keyup",function(t){var n;return t.which>=37&&t.which<=40?!1:(n=k$(t.currentTarget),i(function(){return e.performSearch(n.val())},200),!1)}),this.getElement("employee_or_team").live("click",function(t){var n,i,r;return n=k$(t.currentTarget),i=n.data("recipient"),r=n.data("recipient_type"),e.getElement("recipient").data({recipient:i,recipient_type:r}),e.getElement("popup").hide(),e.getElement("recipient").val(e.settings.locale.myTeamDefault.replace("%s",n.find("span.recipient_name").text())),!1})},e.prototype.performSearch=function(e){var t=this;return e=k$.trim(e),null==e||(null!=e?e.length:void 0)<=0?(this.getElement("popup").hide(),!1):(this.resetAutocomplete(),this.getElement("popup").show(),this.client.searchAll(e,function(e,n,i){var r,s;return e?void 0:(t.getElement("popup").show(),s=t.getElement("teams"),r=t.getElement("employees"),k$.each(i,function(e,n){var i,r,o;return i=t.buildElement("div","team_image"),o=t.buildElement("div").append(t.buildElement("span","team_name recipient_name").html(n.name)).append(t.buildElement("span","team_employees_count").html(n.employees_count+" "+(1===n.employees_count?t.settings.locale.employee:t.settings.locale.employees))),r=t.buildElement("li","employee_or_team").data({recipient:n.id,recipient_type:"team"}),r.append(i).append(o),s.append(r)}),k$.each(n,function(e,n){var i,s,o;return i=t.buildElement("img").attr("alt","").attr("src",n.photoWithMissing()),o=t.buildElement("div").append(t.buildElement("span","employee_name recipient_name").html(n.name)),s=t.buildElement("li","employee_or_team").data({recipient:n.id,recipient_type:"employee"}),s.append(i).append(o),r.append(s)}))}))},e.prototype.setDefaultAutoComplete=function(){return this.getElement("recipient").val(this.settings.locale.myTeamDefault.replace("%s",this.settings.teams[0][0])),this.getElement("recipient").data("recipient","team")},e.prototype.resetAutocomplete=function(){var e;return this.getElement("recipient").data("recipient",null),e=this.getElement("teams").html(""),e=this.getElement("employees").html("")},e.prototype.hideReplies=function(e){return this.getElement("message_replies_list").fadeOut(function(){return k$(this).remove()}),this.getElement("horizontal_slider").animate({left:0},400,function(){return e?e.call():void 0})},e.prototype.hideChatApplication=function(){return this.getElement("main").animate({bottom:0},500)},e.prototype.resetPostNewMessage=function(e){var t=this;return this.getElement("message_list").animate({opacity:1}),this.getElement("vertical_slider").animate({top:0},400,function(){return e&&e.call(),t.getElement("body").val(""),t.getElement("recipient").val(""),t.resetAutocomplete()})},e.prototype.resetPostNewReply=function(e){var t=this;return this.getElement("kamino_message_replies_list").animate({opacity:1}),this.getElement("vertical_slider").animate({top:0},400,function(){return e&&e.call(),t.getElement("reply_body").val("")})},e.prototype.getElement=function(e){return k$("."+this.settings.tagPrefix+"_"+e)},e.prototype.buildElement=function(e,t,n){var i,r,s;null==n&&(n={}),i=document.createElement(e),i.setAttribute("class",""+this.settings.tagPrefix+"_"+t);for(r in n)s=n[r],i.setAttribute(r,s);return k$(i)},e.prototype.clearMessages=function(){return this.getElement("messages").html("")},e.prototype.renderMessages=function(e){var t,n,i,r,s,o,a,l,u,c,h,p=this;if(r=[],e.each("Message",function(e,t){var n;if(n=k$("#"+p.messageIdFor(e)),n.length&&n.data("updated_at")!==e.updated_at){if(0!==t||0!==p.getElement("messages > li").index(n))return n.attr("data-destroyed",""),n.slideUp(function(){return k$(this).remove()}),r.push([t,e])}else if(!n.length)return r.push([t,e])}),r.length)if(s=this.getElement("messages").find("> li:not([data-destroyed])").length,0===s||r[0][0]>=s)for(o=0,l=r.length;l>o;o++)c=r[o],n=c[0],i=c[1],this.getElement("messages").append(this.renderMessage(i));else for(a=0,u=r.length;u>a;a++)h=r[a],n=h[0],i=h[1],0===n?this.addNewMessage(i):(t=this.getElement("messages").find("> li:not([data-destroyed])").eq(n-1),t.after(this.renderMessage(i)));
return this.showOrHideNoMessageNotification()},e.prototype.removeMessage=function(e){var t,n,i;return n=k$("#"+this.messageIdFor(e)),t=k$("#"+this.messageIdFor(e,!0)),t.length>0&&null==e.thread_id?this.hideReplies(function(){return n.slideUp(function(){return k$(this).remove()})}):null==e.thread_id?n.slideUp(function(){return k$(this).remove()}):(i=e.thread(),t.slideUp(function(){return k$(this).remove()}),0===i.replies.length&&k$("#"+this.messageIdFor(i,!0)).removeClass(""+this.settings.tagPrefix+"_first_message"),this.updateMessage(i)),this.showOrHideNoMessageNotification()},e.prototype.addNewMessage=function(e){var t;return null!=e.thread_id?e.thread()&&this.updateMessage(e.thread(),e):(t=this.renderMessage(e,!1,!e.writtenByMe()).hide(),this.getElement("messages").prepend(t),t.slideDown()),this.updateCounter(),this.showOrHideNoMessageNotification()},e.prototype.messageIdFor=function(e,t){return null==t&&(t=!1),t?""+this.settings.tagPrefix+"_full_message_"+e.id:""+this.settings.tagPrefix+"_message_"+e.id},e.prototype.updateMessage=function(e,t){var n,i,r,s,o,a,l,u;return u=k$("#"+this.messageIdFor(e)),l=k$("#"+this.messageIdFor(e,!0)),u.length>0&&(i=u.find("."+this.settings.tagPrefix+"_message_meta"),0===l.length&&t&&!t.writtenByMe()&&(a=this.buildElement("span","updated").text(this.settings.locale.updated).hide(),o=this.buildElement("span","spacer").text(" ").hide(),r=u.find("."+this.settings.tagPrefix+"_new, ."+this.settings.tagPrefix+"_spacer, ."+this.settings.tagPrefix+"_updated"),r.length>0?r.fadeOut(function(){return r.remove(),i.prepend(o.fadeIn()).prepend(a.fadeIn())}):i.prepend(o.fadeIn()).prepend(a.fadeIn())),s=u.find("."+this.settings.tagPrefix+"_reply_count"),s.text(this.settings.locale.replyCount.replace("%d",e.replies.length))),l.length>0&&null!=t?(l.addClass(""+this.settings.tagPrefix+"_first_message"),n=this.renderMessage(t,!0),this.getElement("replies").append(n),this.getElement("replies").animate({scrollTop:this.getElement("replies").prop("scrollHeight")}),e.markRead({force:!0})):void 0},e.prototype.updateCounter=function(){var e,t;return t=k$("."+this.settings.tagPrefix+"_new, ."+this.settings.tagPrefix+"_updated").length,t>0?this.getElement("counter").text(t).fadeIn():this.getElement("counter").fadeOut(),!r&&t>0?(e=this.getElement("main"),e.animate({bottom:"-=20px"},200,function(){return e.animate({bottom:"+=20px"},200)})):void 0},e.prototype.showOrHideNoMessageNotification=function(){var e,t;return e=this.getElement("message_list > ul > li:not([data-destroyed])").length,0===e?(t=this.buildElement("div","messages_notification").html(this.settings.locale.noMessages),this.getElement("vertical_slider").prepend(t)):this.getElement("messages_notification").fadeOut(400,function(){return k$(this).remove()})},e.prototype.renderMessage=function(e,t,n){var i,r,s,o,a,l,u,c,h,p,d,f,m,g;return null==t&&(t=!1),null==n&&(n=!1),l=this.buildElement("li","message",{id:this.messageIdFor(e,t)}),l.data("message",e).data("updated_at",e.updated_at),t&&l.addClass(""+this.settings.tagPrefix+"_full_message"),t&&null==e.thread_id&&e.replies.length>0&&l.addClass(""+this.settings.tagPrefix+"_first_message"),o=this.buildElement("img","image",{src:e.sender.photoWithMissing()}),o.attr("width",52).attr("height",52),a=this.buildElement("div","message_information"),i=this.buildElement("div","message_addressee"),d=e.sender.name,null!=e.thread_id||"team"!==(null!=(m=e.recipient)?m.recipient_type:void 0)&&!e.writtenByMe()||(d+=" <i>"+this.settings.locale.to+"</i> "+e.recipient.name),i.html(d),r=t?this.buildElement("div","message_body").html(e.formatBody()):this.buildElement("div","message_body").text(e.body),u=this.buildElement("div","message_meta"),e.isNewThread()?(u.append(this.buildElement("span","new").text(this.settings.locale["new"])),u.append(this.buildElement("span","spacer").text(" "))):e.hasNewReply()&&(u.append(this.buildElement("span","new").text(this.settings.locale.updated)),u.append(this.buildElement("span","spacer").text(" "))),f=Kamino.Util.dateToIsoString(t?e.created_at:e.updated_at),p=this.buildElement("span","time",{title:f}).text(f),u.append(p),p.timeago(),t||(u.append(this.buildElement("span").text(", ")),h=this.buildElement("span","reply_count"),(null!=(g=e.replies)?g.length:void 0)>0?h.text(this.settings.locale.replyCount.replace("%d",e.replies.length)):h.text(this.settings.locale.noReplies)),u.append(h),e.writtenByMe()&&t&&(u.append(this.buildElement("span").text(", ")),c=this.buildElement("a","remove_message",{"data-message-id":e.id,href:"#"}),c.text(this.settings.locale.remove),u.append(c)),s=this.buildElement("div","clear"),a.append(i).append(r).append(u),l.append(o).append(a),t||l.append(this.buildElement("div","arrow")),l.append(s),l},e.prototype.build=function(){return this.buildBase(),this.buildMessages(this.getElement("horizontal_slider")),this.buildPostNewMessage(this.getElement("vertical_slider"))},e.prototype.buildBase=function(){var e,t,n,i,r,s;return r=this.buildElement("div","main"),s=this.buildElement("div","vertical_slider"),i=this.buildElement("div","horizontal_slider"),n=this.buildElement("div","header").text(this.settings.locale.header),t=this.buildElement("div","counter").text("").hide(),n.append(t),e=this.buildElement("div","content"),s.append(i),e.append(s),r.append(n).append(e),k$("body").append(r)},e.prototype.buildPostNewMessage=function(e){var t,n,i,r,s,o;return r=this.buildElement("div","post_new_message"),i=this.buildElement("form","message_form"),o=this.buildRecipientField(),s=this.buildElement("textarea","body"),t=this.buildElement("div","cancel_button").text(this.settings.locale.cancelButton),n=this.buildElement("div","button").text(this.settings.locale.send),n.addClass(""+this.settings.tagPrefix+"_post_new_message_button"),i.append(o).append(s).append(t).append(n),r.append(i),e.append(r)},e.prototype.buildMessages=function(e){var t,n,i;return n=this.buildElement("div","message_list"),i=this.buildElement("ul","messages"),t=this.buildElement("div","button").text(this.settings.locale.postNewMessageButton),t.addClass(""+this.settings.tagPrefix+"_new_message"),n.append(i).append(t),e.append(n)},e.prototype.buildRepliesForMessage=function(e){var t,n,i,r,s,o,a,l,u;for(s=this.buildElement("div","message_replies_list"),r=this.buildElement("ul","replies"),u=[e].concat(e.replies),a=0,l=u.length;l>a;a++)o=u[a],r.append(this.renderMessage(o,!0));return n=this.buildElement("div","controls_box"),t=this.buildElement("div","back_button").text(this.settings.locale.backButton),i=this.buildElement("div","button").text(this.settings.locale.respond),i.addClass(""+this.settings.tagPrefix+"_new_reply_button"),i.data("message",e),n.append(t).append(i),s.append(r).append(n),this.getElement("horizontal_slider").append(s)},e.prototype.buildNewReplyForMessage=function(e){var t,n,i,r,s,o,a,l;return n=this.buildElement("div","post_new_reply"),r=this.buildElement("form","message_form"),o=this.buildElement("p","recipient"),a="<p><strong>"+this.settings.locale.inReplyTo+"</strong> %s</p>","team"!==(null!=(l=e.recipient)?l.recipient_type:void 0)||e.writtenByMe()?o.html(a.replace("%s",e.recipient.name)):o.html(a.replace("%s",""+e.sender.name+", "+e.recipient.name)),s=this.buildElement("textarea","reply_body"),t=this.buildElement("div","cancel_button").text(this.settings.locale.cancelButton),i=this.buildElement("div","button").text(this.settings.locale.send),i.addClass(""+this.settings.tagPrefix+"_post_new_reply_button"),i.data({message:e}),r.append(o).append(s).append(t).append(i),n.append(r),this.getElement("vertical_slider").append(n)},e.prototype.buildRecipientField=function(){var e,t,n,i,r,s,o,a,l,u,c,h,p,d,f,m,g=this;for(e=this.buildElement("div","autocomplete"),h=this.buildElement("input","recipient",{type:"text",placeholder:this.settings.locale.recipientPlaceholder}),r=this.buildElement("div","popup"),s=this.buildElement("div","results"),t=this.buildElement("ul","employees"),c=this.buildElement("ul","teams"),l=this.buildElement("ul","team_list"),m=this.settings.teams,d=0,f=m.length;f>d;d++)p=m[d],o=this.buildElement("div","team_image"),u=this.buildElement("div").append(this.buildElement("span").addClass("recipient_name").html(p[0])),a=this.buildElement("li","employee_or_team").data({recipient:p[1],recipient_type:"team"}),a.append(o).append(u),l.append(a);return r.append(s).append(c).append(t),r.append(l),e.append(h).append(r),null==localStorage.getItem("kamino.popupNotificationTeamSearch")&&(i=this.buildElement("div","button").css("float","right").css("width","100px").text("OK!"),i.click(function(){return g.removePopupNotification()}),n=this.buildElement("div","popup_notification").html("<div>"+this.settings.locale.popupNotificationTeamSearch+"</div>").append(i),e.append(n)),e},e.prototype.removePopupNotification=function(){var e;return null!=(e=this.getElement("popup_notification"))?(localStorage.setItem("kamino.popupNotificationTeamSearch",!0),e.fadeOut(400,function(){return k$(this).remove()})):void 0},e}(),t=function(){function e(){}var t,n;return n=[1,7,1],t="//ajax.googleapis.com/ajax/libs/jquery/"+n.join(".")+"/jquery.min.js",e.load=function(e){var n,i,r;return r=document.createElement("script"),r.src=t,i=window.jQuery,n=!1,r.onload=r.onreadystatechange=function(){var t;return t=this.readyState,t&&"complete"!==t&&"loaded"!==t||n?void 0:(n=!0,window.k$=jQuery.noConflict(),Kamino.framework=function(){return window.k$},e.initialize(),null!=i?window.jQuery=window.$=i:void 0)},document.getElementsByTagName("head")[0].appendChild(r)},e.available=function(){return"undefined"!=typeof jQuery&&null!==jQuery},e.versionRequirementMet=function(){var e;return e=jQuery.fn.jquery.split("."),e[0]>=n[0]&&e[1]>=n[1]?!0:void 0},e}(),e.prototype.initialize=function(){var e=this;if(!(k$.browser.msie&&parseFloat(k$.browser.version)<8))return this.settings=this.mergeSettings(window.chatApplicationSettings),this.settings.locale=i[window.chatApplicationSettings.locale||"nl"],this.setupTimeAgo(),this.setupKaminoClient(),this.ui=new n(this.settings,this.client),this.ui.initialize(),this.setupKaminoEvents(),setTimeout(function(){return e.client.fetch()},500)},e.prototype.setupTimeAgo=function(){return includeTimeago(),k$.timeago.settings.strings=this.settings.locale.timeago},e.prototype.setupKaminoClient=function(){return this.client=new Kamino.Client(this.settings.token,{limit:6,order:"updated",searchOptions:{employeeLimit:5,teamLimit:3}})},e.prototype.setupKaminoEvents=function(){var e=this;return this.client.messages.on("refresh",function(){return e.ui.renderMessages(e.client)}),this.client.messages.on("create",function(t){return e.ui.addNewMessage(t)}),this.client.messages.on("destroy",function(t){return e.ui.removeMessage(t)}),this.client.messages.on("refresh create destroy",function(){return e.ui.updateCounter()})},e.prototype.mergeSettings=function(e){var t,n;for(t in r)n=r[t],e[t]||(e[t]=n);return e},e}.call(this)},e.call(Kamino),window.chatApplication=new Kamino.ChatApplication}.call(this);